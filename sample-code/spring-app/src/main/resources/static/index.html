<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Java AI SDK Application</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/jquery-jsonview/dist/jquery.jsonview.min.css" rel="stylesheet" >
    <style>
        body { background-color: #f4f6f9; }
        .max-width-container {
            max-width: 550px;
        }
        .endpoint-card {
            margin-bottom: 15px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            opacity: 0;
        }
        code {
            font-family: Courier, monospace;
            font-size: 95%;
            padding: 0.2em;
            padding-left: 0.4em;
            padding-right: 0.4em;
            background-color: #EBEBEB;
            border-radius: 3px;
        }
        .info-tooltip {
            position: relative;
            cursor: help;
        }
        .info-tooltip .tooltip-content {
            visibility: hidden;
            position: absolute;
            background-color: #f9f9f9;
            border: 1px solid #ddd;
            padding: 10px;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            width: 250px;
            bottom: 125%;
            right: 15%;
            transform: translateX(-50%);
            z-index: 1;
            opacity: 0;
            transition: opacity 0.3s;
        }
        .info-tooltip:hover .tooltip-content {
            visibility: visible;
            opacity: 1;
        }

        .footer {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 10px;
            background-color: #f8f9fa;
            border-top: 1px solid #e7e7e9;
            position: fixed;
            bottom: 0;
            width: 100%;
        }
        .footer-links {
            display: flex;
            gap: 15px;
            justify-content: center;
            flex: 1;
        }

        .spinner-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            background-color: rgba(255, 255, 255, 0.8);
            z-index: 1050; /* Above modal and other elements */
        }

        .streaming-content {
            overflow-y: auto;
            white-space: pre-wrap;
            word-wrap: break-word;
            font-family: monospace;
        }

        .modal-header {
            display: flex;
            align-items: center;
            position: relative;
        }

        .modal-header .btn-group {
            position: absolute;
            right: 50px;
            top: 50%;
            transform: translateY(-50%);
        }


        #content-container pre {
            white-space: pre-wrap;
            word-wrap: break-word;
            max-height: 500px;
            overflow-y: auto;
        }

    </style>
</head>
<body>

<!-- Spinner Overlay -->
<div id="loading-spinner" class="spinner-overlay d-none">
    <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Loading...</span>
    </div>
</div>

<!-- Modal -->
<div class="modal fade" id="exampleModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h1 class="modal-title fs-5" id="exampleModalLabel">Response</h1>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">

            </div>
        </div>
    </div>
</div>

<!-- API endpoints in containers -->
<div class="container-fluid py-4">
    <h1 class="mb-4 text-center">Java AI SDK Application</h1>
    <div class="row justify-content-center">
        <div class="col-xl-4 max-width-container">
            <div class="card endpoint-card">
                <div class="card-header">
                    <h2>AI Core</h2>
                    The AI Core API offers functionality for managing your scenarios, configurations and deployments.
                    For more information, check the <a href="https://help.sap.com/docs/sap-ai-core/sap-ai-core-service-guide/generative-ai-hub-in-sap-ai-core-7db524ee75e74bf8b50c167951fe34a5">AI Core Documentation</a>
                </div>
                <div class="card-body">
                    <h5>Java Specific Deployments</h5>
                    <ul class="list-group">
                        <li class="list-group-item">
                            <div class="info-tooltip">
                                <a class="link-offset-2-hover link-underline link-underline-opacity-0 link-underline-opacity-75-hover endpoint"
                                   href="/deployments/by-config/67e8d039-c7f1-4179-9f8f-60d158a36b0e/createDelete"><code>/deployments/by-config/[...]/createDelete</code></a>
                                <div class="tooltip-content">
                                    Create and delete a deployment with the Java specific configuration ID.
                                </div>
                            </div>
                        </li>
                        <li class="list-group-item">
                            <div class="info-tooltip">
                                <a class="link-offset-2-hover link-underline link-underline-opacity-0 link-underline-opacity-75-hover endpoint"
                                   href="/deployments/by-config/67e8d039-c7f1-4179-9f8f-60d158a36b0e/stop"><code>/deployments/by-config/[...]/stop</code></a>
                                <div class="tooltip-content">
                                    Stop all deployments with the Java specific configuration ID. Only RUNNING deployments can be STOPPED.
                                </div>
                            </div>
                        </li>
                        <li class="list-group-item">
                            <div class="info-tooltip">
                                <a class="link-offset-2-hover link-underline link-underline-opacity-0 link-underline-opacity-75-hover endpoint"
                                   href="/deployments/by-config/67e8d039-c7f1-4179-9f8f-60d158a36b0e/delete"><code>/deployments/by-config/[...]/delete</code></a>
                                <div class="tooltip-content">
                                    Delete all deployments with the Java specific configuration ID. Only UNKNOWN and STOPPED deployments can be DELETED
                                </div>
                            </div>
                        </li>
                        <li class="list-group-item">
                            <div class="info-tooltip">
                                <a class="link-offset-2-hover link-underline link-underline-opacity-0 link-underline-opacity-75-hover endpoint"
                                   href="/deployments/by-config/67e8d039-c7f1-4179-9f8f-60d158a36b0e/getAll"><code>/deployments/by-config/[...]/getAll</code></a>
                                <div class="tooltip-content">
                                    Get all deployments with the Java specific configuration ID.
                                </div>
                            </div>
                        </li>
                    </ul>
                    <br>
                    <h5>All Deployments</h5>
                    <ul class="list-group">
                        <li class="list-group-item">
                            <div class="info-tooltip">
                                <a class="link-offset-2-hover link-underline link-underline-opacity-0 link-underline-opacity-75-hover endpoint"
                                   href="/deployments/getAll"><code>/deployments/getAll</code></a>
                                <div class="tooltip-content">
                                    Get all deployments, including non-Java specific deployments.
                                </div>
                            </div>
                        </li>
                    </ul>
                    <br>
                    <h5>Scenarios</h5>
                    <ul class="list-group">
                        <li class="list-group-item">
                            <div class="info-tooltip">
                                <a class="link-offset-2-hover link-underline link-underline-opacity-0 link-underline-opacity-75-hover endpoint"
                                   href="/scenarios"><code>/scenarios</code></a>
                                <div class="tooltip-content">
                                    Get the list of available scenarios.
                                </div>
                            </div>
                        </li>
                        <li class="list-group-item">
                            <div class="info-tooltip">
                                <a class="link-offset-2-hover link-underline link-underline-opacity-0 link-underline-opacity-75-hover endpoint"
                                   href="/models"><code>/models</code></a>
                                <div class="tooltip-content">
                                    Get the list of available models.
                                </div>
                            </div>
                        </li>
                    </ul>
                    <br>
                    <h5>Configurations</h5>
                    <ul class="list-group">
                        <li class="list-group-item">
                            <div class="info-tooltip">
                                <a class="link-offset-2-hover link-underline link-underline-opacity-0 link-underline-opacity-75-hover endpoint"
                                   href="/configurations"><code>/configurations</code></a>
                                <div class="tooltip-content">
                                    Get the list of configurations.
                                </div>
                            </div>
                        </li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="col-xl-4 max-width-container">
            <div class="card endpoint-card">
                <div class="card-header">
                    <h2>Orchestration</h2>
                    The Orchestration API offers functionality for enhancing your LLM calls with Grounding, Templating, Data Masking, Filtering and other.
                    For more information, check the <a href="https://help.sap.com/docs/sap-ai-core/sap-ai-core-service-guide/orchestration">Orchestration Documentation</a>
                </div>
                <div class="card-body">
                    <ul class="list-group">
                        <li class="list-group-item">
                            <div class="info-tooltip">
                                <a class="link-offset-2-hover link-underline link-underline-opacity-0 link-underline-opacity-75-hover endpoint"
                                   href="/orchestration/completion"><code>/orchestration/completion</code></a>
                                <div class="tooltip-content">
                                    Chat request to OpenAI through the Orchestration service with a simple prompt.
                                </div>
                            </div>
                        </li>
                        <li class="list-group-item">
                            <div class="info-tooltip">
                                <a class="link-offset-2-hover link-underline link-underline-opacity-0 link-underline-opacity-75-hover endpoint"
                                   href="/orchestration/template"><code>/orchestration/template</code></a>
                                <div class="tooltip-content">
                                    Chat request to OpenAI through the Orchestration service with a template.
                                </div>
                            </div>
                        </li>
                        <li class="list-group-item">
                            <div class="info-tooltip">
                                <a class="link-offset-2-hover link-underline link-underline-opacity-0 link-underline-opacity-75-hover endpoint"
                                   href="/orchestration/messagesHistory"><code>/orchestration/messageHistory</code></a>
                                <div class="tooltip-content">
                                    Chat request to OpenAI through the Orchestration service using message history.
                                </div>
                            </div>
                        </li>
                        <li class="list-group-item">
                            <div class="info-tooltip">
                                <a class="link-offset-2-hover link-underline link-underline-opacity-0 link-underline-opacity-75-hover endpoint"
                                   href="/orchestration/filter/NUMBER_4"><code>/orchestration/filter/NUMBER_4</code></a>
                                <div class="tooltip-content">
                                    Apply both input and output filtering for a request to orchestration with a loose filter.
                                </div>
                            </div>
                        </li>
                        <li class="list-group-item">
                            <div class="info-tooltip">
                                <a class="link-offset-2-hover link-underline link-underline-opacity-0 link-underline-opacity-75-hover endpoint"
                                   href="/orchestration/filter/NUMBER_0"><code>/orchestration/filter/NUMBER_0</code></a>
                                <div class="tooltip-content">
                                    Apply both input and output filtering for a request to orchestration with a strict filter.                                </div>
                            </div>
                        </li>
                        <li class="list-group-item">
                            <div class="info-tooltip">
                                <a class="link-offset-2-hover link-underline link-underline-opacity-0 link-underline-opacity-75-hover endpoint"
                                   href="/orchestration/maskingAnonymization"><code>/orchestration/maskingAnonymization</code></a>
                                <div class="tooltip-content">
                                    Let the orchestration service evaluate the feedback on the AI SDK provided by a hypothetical
                                    user. Anonymize any names given as they are not relevant for judging the sentiment of the
                                    feedback.
                                </div>
                            </div>
                        </li>
                        <li class="list-group-item">
                            <div class="info-tooltip">
                                <a class="link-offset-2-hover link-underline link-underline-opacity-0 link-underline-opacity-75-hover endpoint"
                                   href="/orchestration/maskingPseudonymization"><code>/orchestration/maskingPseudonymization</code></a>
                                <div class="tooltip-content">
                                    Let the orchestration service a response to a hypothetical user who provided feedback on the AI
                                    SDK. Pseudonymize the user's name and location to protect their privacy.
                                </div>
                            </div>
                        </li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="col-xl-4 max-width-container">
            <div class="card endpoint-card">
                <div class="card-header">
                    <h2>Foundation Models</h2>
                    The Foundation Models API offers functionality for directly calling a foundation model and using the features provided by its own API.
                    For more information, check the <a href="https://help.sap.com/docs/sap-ai-core/sap-ai-core-service-guide/consume-generative-ai-models-using-sap-ai-core">Foundation Models Documentation</a>
                </div>
                <div class="card-body">
                    <h5>OpenAI</h5>
                    <ul class="list-group">
                        <li class="list-group-item">
                            <div class="info-tooltip">
                                <a class="link-offset-2-hover link-underline link-underline-opacity-0 link-underline-opacity-75-hover endpoint"
                                   href="/chatCompletion"><code>/chatCompletion</code></a>
                                <div class="tooltip-content">
                                    Chat request to OpenAI.
                                </div>
                            </div>
                        </li>
                        <li class="list-group-item">
                            <div class="info-tooltip">
                                <a class="link-offset-2-hover link-underline link-underline-opacity-0 link-underline-opacity-75-hover endpoint"
                                   href="/streamChatCompletion"><code>/streamChatCompletion</code></a>
                                <div class="tooltip-content">
                                    Asynchronous stream of an OpenAI chat request.
                                </div>
                            </div>
                        </li>
                        <li class="list-group-item">
                            <div class="info-tooltip">
                                <a class="link-offset-2-hover link-underline link-underline-opacity-0 link-underline-opacity-75-hover endpoint"
                                   href="/streamChatCompletionDeltas"><code>/streamChatCompletionDeltas</code></a>
                                <div class="tooltip-content">
                                    Asynchronous stream of an OpenAI chat request and provision of complete response.
                                </div>
                            </div>
                        </li>
                        <li class="list-group-item">
                            <div class="info-tooltip">
                                <a class="link-offset-2-hover link-underline link-underline-opacity-0 link-underline-opacity-75-hover endpoint"
                                   href="/chatCompletionTool"><code>/chatCompletionTool</code></a>
                                <div class="tooltip-content">
                                    Chat request to OpenAI with a tool.
                                </div>
                            </div>
                        </li>
                        <li class="list-group-item">
                            <div class="info-tooltip">
                                <a class="link-offset-2-hover link-underline link-underline-opacity-0 link-underline-opacity-75-hover endpoint"
                                   href="/chatCompletionImage"><code>/chatCompletionImage</code></a>
                                <div class="tooltip-content">
                                    Chat request to OpenAI with an image.
                                </div>
                            </div>
                        </li>
                        <li class="list-group-item">
                            <div class="info-tooltip">
                                <a class="link-offset-2-hover link-underline link-underline-opacity-0 link-underline-opacity-75-hover endpoint"
                                   href="/embedding"><code>/embedding</code></a>
                                <div class="tooltip-content">
                                    Get the embedding of a text.
                                </div>
                            </div>
                        </li>
                        <li class="list-group-item">
                            <div class="info-tooltip">
                                <a class="link-offset-2-hover link-underline link-underline-opacity-0 link-underline-opacity-75-hover endpoint"
                                   href="/chatCompletion/ai-sdk-java-e2e"><code>/chatCompletion/resourceGroup</code></a>
                                <div class="tooltip-content">
                                    Chat request to OpenAI filtering by resource group.
                                </div>
                            </div>
                        </li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>

<footer class="footer">
    <div class="footer-links">
        <a href="https://github.com/SAP/ai-sdk-java">GitHub</a>
    </div>
    <div class="info-tooltip">
        ‚ùì
        <div class="tooltip-content">
            Welcome to the Java AI SDK Application. In this Demo and End-to-End Test App you can test several
            endpoints of our API. For more information, check our GitHub repository linked at the bottom.
        </div>
    </div>
</footer>


<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jquery-jsonview/dist/jquery.jsonview.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', () => {
        // Animate cards
        anime({
            targets: '.endpoint-card',
            translateY: [50, 0],
            opacity: [0, 1],
            easing: 'easeOutQuad',
            delay: anime.stagger(200)
        });
    });

    // Get the modal instance
    const modalElement = document.getElementById("exampleModal");
    const modalInstance = new bootstrap.Modal(modalElement);
    const modalBody = modalElement.querySelector('.modal-body');
    const modalTitle = modalElement.querySelector('.modal-title');
    const modalHeader = modalElement.querySelector('.modal-header');

    document.querySelectorAll('.endpoint').forEach(link => {
        link.addEventListener('click', async (event) => {
            event.preventDefault(); // Prevent the default link behavior

            const endpoint = event.target.parentElement.href; // Get the endpoint
            try {
                if (endpoint.includes('streamChatCompletion')) {
                    await handleStreamingResponse(endpoint, event.target.innerHTML);
                } else {
                    const data = await fetchData(endpoint); // Fetch the JSON data from the backend
                    updateDisplay(data, event.target.innerHTML, endpoint, false); // Display the data in the modal
                }
            } catch (error) {
                updateDisplay(error.message, event.target.innerHTML, endpoint, true);
            }
        });
    });

    async function fetchData(endpoint) {
        const spinner = document.getElementById("loading-spinner"); // Get spinner element

        try {
            // Show the spinner
            spinner.classList.remove("d-none");

            const response = await fetch(endpoint);
            if (!response.ok) throw new Error("Error occurred with status code: " + response.status);

            return await response.json();
        } catch (error) {
            console.error("Error fetching data:", error);
            throw error;
        } finally {
            // Hide the spinner
            spinner.classList.add("d-none");
        }
    }

    async function handleStreamingResponse(endpoint, endpointName) {
        const spinner = document.getElementById("loading-spinner");

        try {
            // Show the spinner
            spinner.classList.remove("d-none");

            // Set the modal title
            modalTitle.innerHTML = `<code>${endpointName}</code>`;
            const existingToggleGroup = modalHeader.querySelector('.btn-group');
            if (existingToggleGroup) {
                existingToggleGroup.remove();
            }

            // Prepare the modal body for streaming content
            modalBody.innerHTML = `
                <div class="streaming-content p-3 bg-light border rounded">
                    <div class="stream-container"></div>
                </div>
            `;
            const streamContainer = modalBody.querySelector('.stream-container');

            // Fetch the streaming response
            const response = await fetch(endpoint);

            if (!response.ok) {
                throw new Error(`Error occurred with status code: ${response.status}`);
            }

            // Check if the response is a ReadableStream
            if (response.body) {
                const reader = response.body.getReader();
                const decoder = new TextDecoder();

                // Show the modal early to start displaying stream
                modalInstance.show();

                while (true) {
                    const { done, value } = await reader.read();

                    if (done) break;

                    // Decode the chunk
                    const decodedChunk = decoder.decode(value, { stream: true });

                    // Append the chunk to the stream container
                    streamContainer.innerHTML += escapeHtml(decodedChunk);

                    // Scroll to the bottom of the modal
                    modalBody.scrollTop = modalBody.scrollHeight;
                }
            } else {
                throw new Error('Response is not a stream');
            }
        } catch (error) {
            updateDisplay(error.message, endpointName, endpoint, true);
        } finally {
            // Hide the spinner
            spinner.classList.add("d-none");
        }
    }

    function escapeHtml(unsafe) {
        return unsafe
             .replace(/&/g, "&amp;")
             .replace(/</g, "&lt;")
             .replace(/>/g, "&gt;")
             .replace(/"/g, "&quot;")
             .replace(/'/g, "&#039;");
    }

    function updateDisplay(data, endpointName, endpoint, error) {
        // Set the modal title to the endpointName
        modalTitle.innerHTML = `<code>${endpointName}</code>`;
        const existingToggleGroup = modalHeader.querySelector('.btn-group');
            if (existingToggleGroup) {
                existingToggleGroup.remove();
            }
        if(error) {
            modalBody.innerHTML = `
                    <div class="alert alert-danger" role="alert">
                        ${data}. For more information, check the output of <a href="${endpoint}">${endpointName}</a>
                    </div>
                `;
            modalInstance.show();
            return;
        }

        // Check if the data has a 'content' field
        const hasContentField = data.hasOwnProperty('content');

        // Create a container for the modal content with toggle functionality
        modalBody.innerHTML = `
            <div class="json-display-container">
                <div id="json-container"></div>
                ${hasContentField ? `
                    <div id="content-container" class="d-none p-3 bg-light border rounded mt-3">
                        <pre class="m-0 text-wrap"></pre>
                    </div>
                ` : ''}
            </div>
        `;

        // Render full JSON
        $('#json-container').JSONView(data);

        // If content field exists, set up toggle functionality
        if (hasContentField) {

            // Create toggle buttons in the modal header
            const toggleGroup = document.createElement('div');
            toggleGroup.className = 'btn-group ms-auto';
            toggleGroup.innerHTML = `
                <button id="full-json-btn" class="btn btn-sm btn-outline-primary active">JSON</button>
                <button id="content-json-btn" class="btn btn-sm btn-outline-primary">Message</button>
            `;

            // Insert the toggle group before the close button
            const closeButton = modalHeader.querySelector('.btn-close');
            modalHeader.insertBefore(toggleGroup, closeButton);

            const jsonContainer = document.getElementById('json-container');
            const contentContainer = document.getElementById('content-container');
            const contentPre = contentContainer.querySelector('pre');

            // Render content field
            contentPre.textContent = typeof data.content === 'object'
                ? JSON.stringify(data.content, null, 2)
                : data.content;

            // Get toggle buttons
            const fullJsonBtn = document.getElementById('full-json-btn');
            const contentJsonBtn = document.getElementById('content-json-btn');

            // Toggle functionality
            fullJsonBtn.addEventListener('click', () => {
                fullJsonBtn.classList.add('active');
                contentJsonBtn.classList.remove('active');
                jsonContainer.classList.remove('d-none');
                contentContainer.classList.add('d-none');
            });

            contentJsonBtn.addEventListener('click', () => {
                contentJsonBtn.classList.add('active');
                fullJsonBtn.classList.remove('active');
                contentContainer.classList.remove('d-none');
                jsonContainer.classList.add('d-none');
            });
        }

        // Show the modal
        modalInstance.show();
    }

</script>
</body>
</html>